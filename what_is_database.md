# データベースについて  

## 目次
1. データベースとは何か
2. データベースの3層スキーマ構造
3. データベースの種類について
    - RDB
    - KVS
    - ドキュメントDB
    - カラムDB
    - グラフDB
    - 時系列DB
    - 台帳DB
4. データベースのバックアップについて

### 1. データベースとは何か
データを整合的に(フォーマットを整えて)保持するもの

「システムと切り離せない」  
この世のすべてのサービス・アプリケーションは、かならずデータを取り扱っているため。  

#### データベースとシステム構築
データベースとシステムは密接に関係している。  
そのため、データベースを知るためには、システムを知る必要がある。  
システム構築の流れと、データベースをシステムにどう組み込むかを学ぶ。

#### システム構築の流れ
1. 要件定義
2. 設計
3. 実装
4. テスト
の順で行われる。

- ウォーターフォールモデル  
    - 前の手順に戻らない  
    - 金融系など構築ミスが絶対起こらないもので採用する  
- プロトタイピングモデル   
    - 試作品の作成 -> 公開 -> フィーフォバック -> 要件定義 -> ... と循環的に行う   
    - Webアプリやゲームなど、新機能・新体験が求められるサービスで採用   
    
##### 要件定義とは
ユーザ(顧客)が求める機能の洗い出し  

##### 設計とは
求める機能をどのようなUI/UXで設計するか

##### 実装とは
設計に対してプログラムを記述

##### テストとは
実装したプログラムの品質を担保

#### DB設計から処理系への記述の流れ
設計でDBの設計を組み込んで、それにそって実装(処理系の記述)を行う。  
= データ中心アプローチ DOA(Data Oriented Approach)  
今はもうほとんど使われていない...。  

### 2. データベースの3層スキーマモデル
1. 概念スキーマ
    - DB上の論理データ
    - DBに保持するデータの要素およびデータ同士の関係を定義
    - テーブルにあたる
2. 外部スキーマ
    - 概念スキーマで定義された論理データから必要なデータを取り出したもの
    - ビューなど
3. 内部スキーマ
    - 概念スキーマで定義された論理データを具体的にどのようにDBMS内部に格納するかを定義する。
    - 実際にはデータはファイルに記述する。  
  
  
### 3. データベースの種類について

#### 複数のDBが必要な理由
- 取得されたデータ形式
- データの管理方法
- データの取得方法
- データ量・一つのデータサイズ

システムに合わせて、保存したいデータ、データの取り出し方を変えていく。  
最適な方法を選択するために複数のデータベースがある。  
  
適したDBを選択すれば、リソースの無駄がなく、高速でデータを操作できる。  

ex) AWS クラウドのデータベース

| データベースのタイプ | ユースケース | AWS のサービス |
| :--- | :--- | :--- |
| リレーショナル | 従来のアプリケーション、エンタープライズリソースプランニング (ERP)、カスタマーリレーションシップマネジメント (CRM)、e コマース | Amazon-Aurora_Icon_32_Squid Amazon Aurora Amazon-RDS_Icon_32_Squid Amazon RDS Amazon-Redshift_Icon_32_Squid Amazon Redshift |
| キー値 | トラフィックの多いウェブアプリケーション、e コマースシステム、ゲームアプリケーション | Amazon-DynamoDB_Icon_32_Squid Amazon DynamoDB |
| インメモリ | キャッシュ、セッション管理、ゲームのリーダーボード、地理空間アプリケーション | Amazon-ElastiCache_32 Amazon ElastiCache Amazon-MemoryDB-for-Redis_32 Amazon MemoryDB for Redis |
| ドキュメント | コンテンツ管理、カタログ、ユーザープロファイル | Amazon-DocumentDB_Icon_32_Squid Amazon DocumentDB (MongoDB 互換) |
| ワイドカラム | 高スケールの業界アプリケーション、設備のメンテナンス、多数の装置の管理、ルートの最適化 | Amazon-Managed-Apache-Service_32_Squid Amazon Keyspaces |
| グラフ | 不正検出、ソーシャルネットワーク、レコメンデーションエンジン | Amazon-Neptune_Icon_32_Squid Amazon Neptune |
| 時系列 | モノのインターネット (IoT) アプリケーション、DevOps、産業用テレメトリ | Amazon-Timestream_Icon_32_Squid Amazon Timestream |
| 台帳 | 記録システム、サプライチェーン、銀行トランザクション | Amazon-Quantum-Ledger-Database_Icon_32_Squid Amazon 台帳データベースサービス (QLDB) |

https://aws.amazon.com/jp/products/databases/


#### RDB (リレーショナルデータベース)
"Relational Database" の略。
日本語では「関係データベース」。  
データをテーブルで管理して、表と票の間の関係を定義することで複雑なデータの関連性を取り扱えるようにする。
レコードの取り出しが、O(n)の計算量
  
##### テーブルの構成
テーブルは「列(カラム)」と「行(レコード)」によって構成されている。  
複数のテーブルに共通のカラム(データ属性)を持たせて、それらをSQLで関連付けて取得したりする。  
  
##### 正規化
データベースを設計する際には、正規化という作業を要する。  
第1 ~ 第5まで存在するが、実務で使われるのは第3まで。  
  
##### ACID特性
- Atomicity (原子性)  
- Consistency (一貫性)  
- Isolation (独立性)  
- Durability (耐久性)  

######  Atomicity (原子性)
トランザクションが完全に実行されるか、まったく実行されないかのどちらかでなければいけない。  
- 処理の一部が行われている状態は、まったく存在しないこと
- 完全状態は、処理済みか未処理しかない
- 実現機能は、コミットメント制御

###### Consistency (一貫性)  
トランザクションの終了状態にかかわらず、データベースの整合性が保たれなければいけない。
- 実行結果が矛盾した状態にならない
- 同一処理は、何度実行しても結果が同じ
- 実現機能は、排他制御

###### Isolation (独立性)  
トランザクションを複数同時に実行しても、単独実行の場合と同じ処理結果にならなければいけない。
- 他のトランザクションの影響を受けないこと
- 実現機能は、排他制御

###### Durability (耐久性)  
トランザクションの結果は、障害が発生しても失われてなはいけない。
- トランザクション完了後、ハードウェア障害があっても更新内容は保証される。
- 実現機能は、障害回復機能


#### KVS (キー値、インメモリ)
NoSQLのひとつ。
"Key-Value Store"の略。  
KeyとValueの単純な構造からなるデータストア。  
Keyを指定すると、Keyに関連付けられたValueが呼び出される仕組みになっている。 
K:Vが1対1で対応しているため、O(1)で読み込みが高速。  
データ構造を定義していないためスケールアウトが容易で、分散型データベースに最適。  

#### ドキュメントDB
NoSQLのひとつ。  
データをJSON形式のようなドキュメントで保存してクエリする。  
開発者がアプリケーションコードを使用するようにして、簡単にデータベースを保存してクエリできるようになる。  

#### カラムDB
列方向にデータを扱う(RDBはデータをレコードで扱うのと比較して)。  
集計作業などが得意でデータウェアハウス(データ分析基盤)などに用いる。

#### グラフDB
グラフ構造をそなえたデータベース。  
データ構造がネットワーク上になっている場合に、格納および検索の面で効率が良い。
ノード、エッジ、プロパティで構成されている

#### 時系列DB
タイムスタンプに基づいてデータを取り扱う。  
アクセスログなどに使う。  


#### 台帳DB
ブロックチェーン技術を活用して、データの改ざんを検証することが可能。
ブロックチェーンは、ハッシュによって不可逆的に計算することで一意のデータを割り当てる。
この割り当てたデータを保存して追跡可能にしている。


### 4. DBのバックアップ
バックアップはファイルのコピー
- フルバックアップ
- 差分バックアップ
- 増分バックアップ

#### フルバックアップ
ある時点でシステムに保存されいているすべてのデータをバックアップする方式。  
フルバックアップで保存されたファイルには、すべてのデータが含まれているため、
その時点のバックアップは完全に再現が可能。

#### 差分バックアップ
最初にすべてのデータをバックアップ。  
その後は、前回取得したフルバックアップからの変更・追加されたデータすべてをバックアップする。

```
ex) 

4/10 50GB (フルバックアップ)
4/11 60GB (60 - 50 = 10GB バックアップ) 
4/12 70GB (70 - 50 = 20GB バックアップ)
4/13 90GB (90 - 50 = 40GB バックアップ)
```

#### 増分バックアップ
最初にすべてのデータをバックアップ。  
その後は変更・追加のあるデータだけをバックアップする。

```
ex) 

4/10 50GB (フルバックアップ)
4/11 60GB (60 - 50 = 10GB バックアップ)
4/12 70GB (70 - 60 = 10GB バックアップ)
4/13 90GB (90 - 70 = 20GB バックアップ)
```

##### バックアップコストとリカバリコスト
バックアップによるデータの信頼性と、  
復旧にかかるコストはトレードオフの関係にある。


